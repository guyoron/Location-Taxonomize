<?php

/**
* @file
* A module which creates and maintains a Location Taxonomy
* which is synchronized with Data from the Location module
*/

require_once('location_taxonomize.inc');
require_once('location_taxonomize.admin.inc');

/**
 * Implements hook_locationapi().
 */
function location_taxonomize_locationapi(&$obj, $op, $a3, $a4, $a5) {
  $settings = variable_get('location_taxonomize_settings');
  if (!$settings['enable']) return;
  $vid = variable_get('location_taxonomize_vid');
  switch ($op) {
    // if we're saving a location, synchronize with vocab
    case 'save':
      //dpm($obj);
      $hierarchy = array ('country_name','province_name','city');
      $location = _fix_loc_tmp($obj);
      dpm($location);
      $tids = array();
      // this loops through hierarchy levels and saves terms if necessary
      for ($hlevel = 0; $hlevel < count($hierarchy); $hlevel++) {
        $name = $location[$hierarchy[$hlevel]];
        if ($hlevel == 0) $parentid = -1;
        else $parentid = $tids[$hlevel-1];
        $findterm = _find_term($name, $hlevel, $parentid);
        if (!$findterm) {
          $term = (object) array(
            'name' => $name,
            'vid' => $vid,
          );
          if ($settings['longname_enable']) {
            _location_taxonomy_add_longname(&$term, $hlevel, $location);
          }
          if ($hlevel == 0) {
            $term->parent = array(0, );
          } else {
            $term->parent = array($parentid, );
          }
          taxonomy_term_save($term);
          dpm($term);
          $tids[] = $term->tid;
          drupal_set_message('Saved new Location Taxonomy term: ' . $term->name . ' (' . $term->tid . ')');
        }
        else if ($findterm->tid) {$tids[] = $findterm->tid; dpm($findterm); }
      }
  }
}

/**
 * Adds a longname field to a term
 *
 */
function _location_taxonomy_add_longname(&$term, $hlevel, $location) {
  $settings = variable_get('location_taxonomize_settings');
  $opts = $settings['longname'];
  $fields = $opts['fields'];
  $longname = array();
  switch ($hlevel) {
    case 0:
      if ($fields['country_name']) $longname[] = $location['country_name'];
    break;
    case 1:
      if ($fields['province_name']) {
        $longname[] = $location['province_name'];
      }
      if ($fields['country_name']) {
        if ($opts['country_code']) {
          if ($opts['usa'] && $location['country'] == 'us') $country = 'usa';
          else $country = 'us';
          if ($opts['cap_co']) $longname[] = strtoupper($country);
          else $longname[] = $country;
        } else {
          $longname[] = $location['country_name'];
        }
      }
    break;
    case 2:
      if ($fields['city']) {
        $longname[] = $location['city'];
      }
      if ($fields['province_name']) {
        if ($opts['province_code']) {
          if ($opts['cap_pr']) $longname[] = strtoupper($location['province']);
          else $longname[] = $location['province'];
        } else  $longname[] = $location['province_name'];
      }
      if ($fields['country_name']) {
        if ($opts['country_code']) {
          if ($opts['usa'] && $location['country'] == 'us') $country = 'usa';
          else $country = 'us';
          if ($opts['cap_co']) $longname[] = strtoupper($country);
          else $longname[] = $country;
        } else {
          $longname[] = $location['country_name'];
        }
      }
    break;
  }
  $count = count($longname);
  $longname_str = '';
  for ($i = 0; $i<$count; $i++) {
    $longname_str .= $longname[$i];
    if ($i != $count-1) $longname_str .= $opts['separator'] . ' ';
  }
  $term->location_taxonomize_longname['und'][0]['value'] = $longname_str;
}

/**
 * Given a name, hierarchy level, and parent id, this function returns the term if such a term
 * exists, and FALSE if it doesn't.
 * It returns TRUE if the term was not found but should not be saved
 * NOTE: $parentid is only necessary if $hlevel > 0. Otherwise, set $parentid = -1
 */
function _find_term($name, $hlevel, $parentid) {
  $terms = taxonomy_get_term_by_name($name);
  if (!$terms) return FALSE;      // there are no terms that match
  $withparent = array();      
  // look through matching terms and find the one(s) with the right parent
  foreach ($terms as $term) {
    //dpm($term);
    $parents = taxonomy_get_parents($term->tid);
    if (!$parents && $parentid == -1) $withparent[] = $term;    // for root-level terms  
    else if (array_pop($parents)->tid == $parentid) $withparent[] = $term;  // for all other terms (one parent is assumed)
    //dpm($withparent);
  }
  if (count($withparent) == 1) {      // there is one term that matches exactly
    //drupal_set_message($name . ' is already in, with the right parent. Not saving.');
    return array_pop($withparent);
  } else if (count($withparent) == 0){  // there are no terms that match exactly
    //drupal_set_message('it\'s in, but with different parent. Saving new term: ' . $name);
    return FALSE;
  }
  // if we get here, there was more than one term that matched exactly
  drupal_set_message('too many terms! couldn\'t save!');
  return TRUE;
}

/**
* A temporary fix for an apparent bug, due to which the country_name field is not updated during the call to
* hook_locationapi
*/
function _fix_loc_tmp($loc) {
  $loc['country_name'] = location_country_name($loc['country']);
  $loc['province_name'] = location_province_name($loc['country'],$loc['province']);
  return $loc;
}

/**
* Implements hook_menu()
*/
function location_taxonomize_menu() {
  $items = array(); 
  // module configuration page
  $items['admin/config/content/location_taxonomize'] = array(
    'title' => 'Location Taxonomize',
    'description' => 'Configuration for Location taxonomize module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('location_taxonomize_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );
 
  return $items;
}

/**
 * 
 */
function location_taxonomize_form_validate($form, $form_state) {
  $values = $form_state['values'];
  //  if we're initializing, make sure that there are no interfering vocabs
  $state = $values['location_taxonomize_vocab']['state']; 
  if ($state == 'initialization') {
    $values_init = $values['location_taxonomize_vocab'];
    $vid = variable_get('location_taxonomize_vid');
    if ($vid) form_set_error('','There seems to already be a Vocabulary
                            associated with Location Taxonomize.');
    $vocab = taxonomy_vocabulary_machine_name_load(LOCATION_TAXONOMIZE_VOCAB_NAME);
    if ($values_init['method'] == 'new' && $vocab) {
      form_set_error('','Could not create new Location Taxonomy vocabulary. A vocabulary with the name
                    \'' . LOCATION_TAXONOMIZE_VOCAB_NAME . '\' already exists.');
    }
    if ($values_init['method'] == 'existing') {
      if (!$vocab) form_set_error('', 'Could not use the existing vocabulary. There is no existing vocabulary with the name 
                                  \'' . LOCATION_TAXONOMIZE_VOCAB_NAME . '\'');
      else if ($vocab->vid != $values_init['possible_vid']) {
        form_set_error('', 'Could not use the existing vocabulary (vid ' . $values_init['possible_vid'] . '). Wrong vid.');
      }
    }
  }
  
}

/**
 * Called from the configuration form. Handles initialization of Location Taxonomy
 */
function location_taxonomize_initialize($form, $form_state) {
  $values_init = $form_state['values']['location_taxonomize_vocab'];
  $method = $values_init['method'];
  switch ($method) {
    case 'new':
      // create a new location vocabulary
      taxonomy_vocabulary_save((object) array(
        'name' => 'Location',
        'machine_name' => LOCATION_TAXONOMIZE_VOCAB_NAME,
        'description' => 'This vocabulary is synchronized with Location data automatically by the ' . LOCATION_TAXONOMIZE_MODULE_NAME . ' module',
        ));
      // save the vid of the newly created vocabulary
      $vocab = taxonomy_vocabulary_machine_name_load(LOCATION_TAXONOMIZE_VOCAB_NAME);
      $vid = $vocab->vid;
      variable_set('location_taxonomize_vid', $vid);
      $msg = 'Successfully created the Location taxonomy (vid ' . $vid . ')';
    break;
    case 'existing':
      // save the vid of the existing vocabulary
      $vid = $values_init['possible_vid'];
      variable_set('location_taxonomize_vid', $vid);
      $msg = 'Successfully connected to the existing Location Vocabulary (vid ' . $vid . ')';
    break;
  }
  drupal_set_message($msg);
  // Create the 'taxonomy_longname' field if it doesn't already exist.
  if (!field_info_field('location_taxonomize_longname')) {
    $field = array(
      'field_name' => 'location_taxonomize_longname', 
      'type' => 'text', 
    );
    field_create_field($field);
  }
  if (!field_info_instance('taxonomy_term','location_taxonomize_longname','location_taxonomize')) {
    // Create the instance on the bundle.
    $instance = array(
      'field_name' => 'location_taxonomize_longname',
      'label' => 'Long Name', 
      'entity_type' => 'taxonomy_term', 
      'bundle' => 'location_taxonomize',
    );
    field_create_instance($instance);
  }
  drupal_set_message(t('Attached the Long Name field to the vocabulary'));
  drupal_set_message(t('Location Taxonomy initialized successfully'));
}

function location_taxonomize_disassociate($form, $form_state) {
  // unset the vid variable
  variable_del('location_taxonomize_vid');
  drupal_set_message('Location Taxonomy successfully disassociated.');
}
